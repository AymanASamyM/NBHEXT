var partyNum = 0;
var ratings = [1683,1897,1506,1847,1720,1821,1743,1774,1757,0,1711,1890,1864,1603,1871,1779,1896,1816,1625,1860,1631,1813,1886,1780,1837,1767,1879,1795,1859,1794,1729,1696,1826,0,1641,1769,1864,1818,1800,1784,1536,1713,1645,1551,1739,1751,1736,1819,0,1764,1707,1709,1847,1522,1830,1739,1650,1884,1782,1719,1792,1721,1747,1855,1814,1719,1672,1699,1852,1794,0,1850,1786,1683,1680,1661,1802,1534,1714,1688,1583,1748,1515,1758,1785,1835,1802,1752,1726,1647,1780,1813,1879,1750,1896,1678,1855,1666,1825,1728,1828,1764,1845,1859,1723,1727,1851,1769,1809,1664,1796,1755,1413,1763,1597,1769,1656,1822,1637,1882,1694,1820,1722,1680,1859,1706,1859,1659,1794,1385,0,1500,1647,1864,1679,1698,1581,1697,1761,1666,1626,1586,1641,1634,1701,1741,1602,1753,1866,1724,1721,1519,1525,1683,1625,1560,1896,1545,1822,1763,1684,1665,1573,1722,1635,1758,1669,1832,1773,1615,1760,1748,1650,1749,1702,1809,1716,1667,1585,1870,1731,1485,1734,1572,1822,1658,1566,1624,0,1879,1742,1642,1839,1698,0,1765,1759,1748,1554,1865,1636,1755,1781,1410,1700,1754,1710,1739,1677,1632,1847,1774,1695,0,1863,1839,1879,1638,1557,1809,1753,1734,1788,1727,1643,0,1859,1777,1796,1647,1655,1898,1795,1631,1544,1898,1718,1888,1715,1785,1876,1784,1777,1687,1727,1618,1579,1720,1766,1634,1735,1805,1747,1605,1799,1702,1591,1695,1492,1585,1852,1543,1579,1770,1545,1777,1786,1720,1841,1676,1544,1677,1853,1580,1550,1449,1729,1634,1783,1629,1740,1602,1744,1701,1701,1784,1713,1568,0,1670,1802,1865,1757,1875,1701,1643,1579,1692,1749,1765,1803,1893,1871,0,1513,1748,1794,1748,1712,1546,1588,1801,1721,1750,1628,1764,1622,1781,1765,1700,1769,1781,1601,1748,1721,1723,1798,1619,1661,1800,1698,1748,1723,1450,1551,1491,1634,1889,1619,1711,1712,1555,1570,1743,1742,1642,1646,1629,1610,1772,1636,1636,1858,1494,1889,1527,1889,1521,1764,1685,1592,1755,1709,1651,1455,1787,1718,1596,1763,1668,1767,1811,1732,1886,1700,0,1811,1755,1757,1521,1665,1652,1881,0,1720,1550,1547,1886,1797,1806,1677,0,1696,1512,1671,1635,1686,1460,1748,0,1789,1710,1603,1579,1462,1800,1886,1661,1757,1657,1518,1870,1694,1708,1810,1566,1744,1762,1663,1697,1747,1680,1677,1491,1544,1663,1842,1727,1519,1712,1589,1376,1623,1552,1697,1798,1746,1528,1760,1814,1683,1794,1627,1716,1605,1531,1637,1645,1593,1349,1404,1462,1702,1617,1557,1595,1606,1577,1755,1604,1705,1707,1795,1708,1712,1735,1714,1734,1627,1864,1391,1722,1835,1856,1717,1748,1758,1691,1560,1603,1559,1738,1568,1655,1733,1303,1676,1891,1726,1556,1702,1617,1560,1821,0,1709,1765,1662,1518,1877,1771,1717,1774,1842,1564,1731,1557,1676,1690,1481,1574,1570,0,1480,1836,1571,1658,1807,1614,1705,1599,1647,1651,1501,1517,1447,1789,1452,1563,1678,1703,1545,1616,1426,1607,1803,1641,1502,1696,1551,1606,1728,1852,1712,1616,1532,1656,1693,1488,1495,1783,1499,1556,1656,1558,1454,1798,1742,1512,1440,1600,1795,1467,1574,1565,1605,1704,1603,1760,1728,1473,1710,1639,1445,1718,1678,1784,1706,1362,1429,1527,1485,1719,1415,1763,1753,1670,1888,1328,1722,1755,1550,1692,1763,1440,1667,0,1673,1867,1761,1819,1563,1753,1739,1413,1520,1754,1588,1449,1788,1725,1711,1613,1657,1364,1662,1676,1712,0,1628,1513,1661,1719,1646,1751,1771,1480,1725,1552,1656,1708,1661,1547,1442,1761,1519,1532,1695,1537,1683,1393,1562,1572,1732,1697,1555,1441,1323,1614,1732,1445,0,1735,1511,0,1602,1307,1887,1514,1593,1500,1616,0,1687,1543,1518,1479,1724,1732,1602,1847,1650,0,1830,1630,1699,1485,1884,1511,1553,1468,1656,1655,1471,0,1425,1505,1683,1512,0,1467,1602,1674,1431,1775,1641,1667,1583,1378,1642,1517,1810,1511,1533,1730,1509,1510,1706,1561,1628,0,0,1372,1568,1788,1577,1478,1393,1687,1665,1406,1365,1486,1559,1600,1388,1720,1581,1658,1606,1579,1518,0,1739,1625,1717,1509,0,1306,1857,1633,1858,1727,1614,1592,1655,1583,1585,1589,1588,1405,1527,1337,1669,1857,1511,1710,1554,1788,1498,1662,1441,1509,1877,0,1684,1708,1483,1528,1455,1565,1369,1467,1740,1738,1662,1837,1806,1583,1467,1767,1731,0,1670,1773,1878,1885,1766,1704,1575,1679,1654,1700,1653,1703,1349,1371,1663,1813,1646,1591,1404,1737,1601,1783,1567,1758,1597,1514,1844,1846,1640,1446,1482,1854,1701,1617,1580,1534,1607,1722,1726,1498,1734,1518,1723,1328,1604,1758,1631,1561,1443,1492,1592,1511,1512,1767,1666,1489,1544,1701,1439,1678,1667,1570,1264,1788,1618,1231,1613,1631,1694,1709,1598,1553,1711,1768,1715,1512,1620,1726,1697,1745,1595,1796,1672,1596,1305,1674,1495,1468,1795,1797,0,1735,1413,1771,1531,1606,1363,1358,1213,1471,1628,1587,1733,1590,1736,1526,1684,1714,1676,1643,1589,1330,1728,1844,1720,1406,1549,1388,1644,1602,1754,1696,1405,1549,1301,1628,1500,1399,1591,1734,1703,1690,1619,1457,1739,1523,1402,1245,1468,1541,1580,1661,1446,1392,1669,1453,1553,1752,1628,1638,1411,1321,1494,1552,1754,1727,1681,1492,1651,1283,1442,1581,1498,1148,1652,1401,1356,1442,1426,1674,1638,1407,1641,1693,1659,0,1516,1615,1648,1834,1766,1755,1735,1714,1526,1476,1540,1289,1496,1693,1627,1478,1690,1499,1610,1699,1532,1471,0,1640,0,1586,1426,1541,1387,1599,1496,1784,1594,1550,1358,1305,1513,1503,1823,1828,1621,1538,1553,0,1614,1430,1732,1708,0,1750,1664,1476,1327,1541,1476,1884,1566,1683,1525,1622,1405,1568,1170,0,1408,1473,1735,1806,1766,1621,0,1676,1442,0,1867,1498,0,1277,1663,1468,1596,1713,1704,1441,1899,1733,1699,1720,1170,1701,1446,1665,1465,1271,1604,1537,1697,1597,1410,1686,1670,1181,1372,1501,1384,1667,1527,1366,1689,1500,1434,1530,1664,1814,1639,1589,1344,1773,1318,1654,1789,1487,1466,1354,1431,1701,1588,1616,1593,1328,1674,1280,1239,1260,1701,1515,1724,1759,1307,1458,1732,1817,1690,1504,1437,1532,1515,1423,1496,1685,1440,1538,1553,1806,0,0,1725,1518,1524,1740,1407,1522,1629,1294,1539,1623,1538,1541,1639,1558,1330,1749,1621,1349,1640,1461,1394,1463,1503,1248,0,1702,1761,1617,1329,1782,1568,1640,1548,1644,1802,1603,1613,1406,1448,1457,1542,1512,1709,1570,1420,1834,1621,1473,1821,1583,1144,1452,1538,1578,1548,1633,1302,1402,1575,1272,1713,1492,1505,1732,1587,1527,1719,1379,1517,1688,1630,1661,1600,1372,1587,1285,1388,1364,1406,1483,1461,1426,1532,1278,1401,0,1500,1345,0,1679,1318,1594,1707,1517,1667,1779,979,1448,1501,1464,1511,1790,1609,1524,1564,1700,1403,1385,1486,1600,1675,0,1385,1583,1583,1300,1561,1343,1579,1431,1707,1468,0,1369,1766,0,1321,1255,1605,1449,1404,1876,1652,1470,1639,1439,1408,0,1509,1674,1244,1519,1408,1424,1465,906,1681,1619,1506,1624,0,1561,1735,1368,1671,1313,1458,1368,1623,1389,1485,1450,1553,1341,1220,1586,1466,1338,1590,1364,1446,1435,1472,1586,1517,1263,1409,1477,1519,1730,1313,1554,1457,1391,1406,1619,1321,1619,1429,0,1327,1597,1331,0,1486,0,1501,1425,0,1476,1385,1332,1479,1559,1218,1600,1605,1603,1482,1347,1406,1499,1342,1826,909,1589,1488,1404,1393,1397,1664,1384,1416,0,1275,1274,1470,1536,1225,1395,1547,1715,1347,1324,1530,1241,1572,1430,1624,1486,1579,1505,1481,1409,1797,1484,1583,1563,0,1459,1666,1484,1631,1588,1443,1469,1393,0,1683,0,1662,1580,1515,1387,1609,1271,1563,0,1608,1322,1442,1445,0,1450,1308,1425,1467,1807,1465,1196,1511,0,0,1509,1295,1383,1242,0,1443,1492,1542,1408,1423,1461,1337,1256,1696,1559,1586,0,1414,1682,1749,1077,1356,1449,1263,1615,1581,1433,1543,0,1604,0,1442,1538,1258,1724,1442,0,1478,0,1510,1559,1440,1399,1235,1403,1446,1350,0,1672,1558,1473,1441,1459,1385,1690,1335,1498,1323,1369,1377,1633,0,1220,1259,1296,1338,1464,1334,1331,1404,1658,1414,1475,0,1661,1211,1403,1608,1295,1674,1673,1449,0,1299,1460,1687,1260,1512,1478,1740,1381,1420,0,1282,1449,1562,1539,1381,1462,1701,1523,1365,1531,1640,1341,1442,1552,1243,1476,1339,1453,1355,1326,1344,1478,1389,1182,1491,1559,1273,1422,1429,1672,1400,1648,1407,1566,1446,1424,0,1560,1438,1517,1674,1436,1595,1428,1287,0,1513,1534,1431,1200,1452,1406,1393,1464,1466,1783,0,1511,1443,1365,1595,0,1473,1298,1148,1367,1337,1536,1683,1255,1451,1481,1325,1526,1603,0,1809,1310,1583,1324,1603,1333,1389,1252,1286,1234,1541,1348,1479,1503,1537,1250,1388,1734,1408,1517,1362,1484,1436,1402,1276,1499,1503,1415,1477,1272,1234,1453,1473,1419,1316,1376,1489,1522,1423,1441,1101,1303,1453,1722,1264,1620,1305,1533,1432,1501,1208,1547,1527,1449,1425,0,1359,1432,1437,1345,1723,1544,1365,1335,1611,1380,1461,1340,1479,1240,1364,1323,1160,1388,1147,1411,1157,1375,1732,1392,1462,1640,1574,1164,1095,1714,1372,1389,1709,1449,1282,1174,982,1471,1454,1491,0,1595,1447,1625,0,1140,1271,1696,1644,1085,1269,1604,1457,1444,1507,1463,1276,1749,1366,1794,1163,1527,0,1564,1398,1319,1528,1135,1781,1271,1390,1327,1431,1424,1289,1725,1351,1449,1382,1268,1613,1560,1207,1234,1241,1288,1438,1738,1422,1420,1313,1368,0,1236,1336,1374,1064,1214,1467,1216,1358,1330,1549,1377,1143,1135,1442,1756,1744,1316,1483,1538,1469,1459,1283,0,1380,0,1642,1472,1377,1212,1714,1483,1599,1252,1496,1234,1511,1029,1276,1087,1638,1562,1478,1408,1434,1201,1303,1308,1377,0,0,1341,1484,1457,1254,1363,0,1099,1342,1532,1277,1342,1234,1291,1368,1582,1559,1445,1568,1409,1214,1393,1383,1723,1698,1531,0,1295,1347,1317,1370,0,1709,1330,1303,1269,1422,1433,1428,1393,1394,1457,1281,0,1461,1259,1367,1328,1411,1469,1551,1200,1330,1614,1605,1359,1405,1458,1436,1417,1490,1211,1368,1304,1564,1312,1264,1417,1669,0,0,1290,1174,1330,1427,0,1347,1524,1312,0,1471,1390,1559,1105,1091,1584,1205,1435,1454,1331,1387,1250,1356,1659,1661,1379,1667,1548,0,1579,1174,0,1368,1310,1077,1691,1533,1285,1482,1418,0,1613,0,1385,1301,1545,1488,1562,1366,1697,1358,1227,1403,1246,1554,1410,1271,1465,0,1424,0,0,1432,1387,0,1258,1398,1408,1431,1344,1473,1538,1487,1328,1162,1189,1433,0,1391,1620,1665,1205,1350,1259,1476,1374,1157,1377,1485,1370,1238,0,1741,1313,1422,1385,1703,1552,1395,1473,1518,1426,1601,0,0,1558,1376,1468,1318,1633,1337,0,1266,1196,0,0,1549,1465,1328,1533,1209,1563,1477,1517,0,1452,1443,1293,1393,1110,0,0,1424,0,1442,1514,1361,1376,1307,1369,1056,1161,1445,1092,1069,1478,1541,1429,841,1805,1148,1610,0,1536,1478,1340,1171,0,1515,1258,0,1446,1226,1296,1478,1318,1340,1445,1246,1282,1280,1329,1531,1306,1074,0,0,1579,1212,1363,1408,1494,1301,0,1677,1257,1407,1465,1433,1301,1391,1009,1444,1393,1533,1434,1448,949,0,1177,0,0,1450,1192,1318,1396,1302,1376,0,1467,1346,1403,1214,1377,1691,0,1497,0,1772,0,1184,1272,1498,1453,0,1235,1148,1044,1433,1222,1346,1272,1063,0,1305,1042,1416,1362,1284,1190,1410,1477,1201,1397,1289,1283,0,1299,1398,1257,1496,0,1141,1464,1347,1207,1042,1229,1176,1136,0,1249,1100,1316,0,1242,1343,1357,1193,1467,1374,1057,1071,1394,1505,1171,1448,0,0,0,1193,1419,945,0,1391,0,1521,1126,1424,1341,1306,990,1412,1140,1697,1367,1087,1382,1354,1609,1389,1408,1223,1427,1496,1349,0,1586,1423,1746,1328,0,1225,1416,1599,0,1463,1427,0,1349,1463,1123,0,1224,1630,0,1463,0,1480,1248,1185,1282,1433,0,1379,1491,0,0,1233,1110,1534,0,1433,1173,1342,1355,1382,1432,1280,1419,1272,1522,1351,1408,1221,0,1421,1078,1352,1362,1225,1266,1383,1509,1277,1525,1335,1244,707,1164,1160,0,1401,1541,1072,1298,1483,1680,0,1474,1382,1637,1460,1123,0,1433,1433,1360,0,1382,1053,1494,1187,0,1219,0,1319,1242,1394,1296,1067,1281,1362,1387,0,1249,1355,1431,1219,1255,1530,1104,1220,0,1493,1085,1328,1699,1444,0,0,1572,1519,1145,1012,1457,1605,1683,1315,1685,1703,1466,1541,1298,1240,1667,1181,1359,1700,1597,1166,1341,1593,0,1308,1406,1157,1576,1446,1622,1627,0,0,1446,1256,1275,1371,1425,1236,1422,1366,1610,1055,1443,1588,1729,1254,1384,1216,1467,1148,1419,1436,1397,1536,1603,975,1254,1401,1471,1447,1292,1211,0,1050,1314,0,1172,1433,1539,1287,1377,0,1275,1601,1414,1097,1179,1210,0,0,1406,1343,1481,1495,1457,1493,1149,0,868,1459,1203,1555,0,1424,1041,1300,1424,1409,1087,1232,1146,1433,0,1358,1187,1560,1444,1388,1253,1067,1196,1312,1150,1444,1331,1347,1319,1301,1284,1404,1446,0,1178,1462,1388,1191,1269,1390,0,1291,1386,0,1141,0,1390,1054,0,1191,1375,0,1234,0,1446,1305,1312,1406,1306,1243,1733,0,1498,1313,0,1382,0,1137,1309,1407,1385,1432,1663,1569,1465,1496,0,1558,1413,1076,1115,1221,1665,1195,1476,1320,1114,1399,1393,0,1253,1095,1088,0,998,1472,1333,0,1264,907,1466,1423,1356,0,0,1214,1037,0,0,1360,1219,1658,1036,1432,0,1369,1362,1436,0,1191,1244,1458,1534,1192,1433,0,1275,917,919,1316,1353,1325,1683,1319,1378,956,1325,1403,983,1264,1457,1296,0,0,0,1169,1238,1396,1422,1313,1291,1360,1445,1208,1400,1267,1218,0,0,0,1388,1461,0,1285,1415,0,1064,0,0,1340,0,1237,1421,1491,1377,1246,1257,1440,1383,1420,1181,0,1103,0,1167,1276,921,1433,0,0,1280,1406,924,1488,0,1433,0,1069,1037,1362,0,1435,1404,1156,1369,1246,1123,1493,1359,1268,0,1442,1158,1295,1297,1080,1155,1266,1429,1391,1192,0,1406,1236,1233,1159,0,0,0,1373,1146,1419,1215,1306,0,1329,1249,1423,0,1214,911,1322,1368,1046,0,1406,0,1068,1285,1211,1424,1437,1212,0,0,1404,1144,1468,1224,1410,1314,0,1315,1502,1476,0,966,1424,926,1712,0,1367,772,1093,1345,0,1445,0,0,1085,1566,0,1091,1423,1373,0,1336,1195,1338,1406,1347,1043,1111,0,0,1010,1103,1397,0,1147,0,0,1268,0,1470,0,1334,0,1221,1224,1107,0,1059,1406,0,1475,1232,1192,0,1409,1245,1206,1330,1409,1469,0,1354,0,1439,1226,1269,1091,1345,1315,0,1305,1144,0,1169,0,992,1148,1406,1086,0,0,1316,1432,1157,0,0,1438,1233,1195,0,1407,1337,1166,1071,0,1235,1581,1440,1179,1183,1710,1452,1441,1113,1374,0,1460,0,1125,0,1304,1358,1316,0,1248,1110,1077,0,880,0,1227,1258,1009,0,1464,1118,0,1436,0,1110,1441,0,1407,1361,1239,1413,0,1183,0,1002,0,1113,1344,1059,1031,1408,0,1699,0,0,1092,1402,1366,0,0,1411,0,1301,0,918,1393,1435,1230,1406,0,0,1409,1343,1223,1126,1152,1326,1317,825,1147,0,1343,0,1200,1290,0,1182,1318,1242,1069,1143,0,1003,0,1096,1181,1376,0,1251,1363,1422,0,1411,1159,0,0,1401,1336,1430,1204,1176,1234,1256,1362,0,1406,1431,0,1220,1398,1385,1310,1070,1222,0,1232,1162,1344,0,1250,1292,0,1133,1333,1090,1425,1277,1334,1405,1034,1194,1318,1320,0,1184,0,1039,1235,1386,1140,0,1008,1175,1430,1284,1407,1084,1300,1397,1170,0,0,1201,0,0,1270,1165,1417,1055,1429,0,1128,1268,0,0,1167,1448,0,1413,1400,1348,0,1372,1180,0,1566,1223,0,1531,1482,1406,1169,1404,0,1147,1270,1240,839,0,689,1288,0,1046,1445,1375,0,0,1426,0,1344,1344,0,0,1301,0,1257,0,1398,0,0,1417,1407,1401,1250,0,0,1071,1148,1355,0,1416,1170,1440,1446,736,1556,1206,1464,1143,1196,1433,1439,1065,0,1386,1248,0,911,1071,0,1274,1361,955,1283,0,1081,1334,0,1383,1465,1408,0,0,1408,0,1058,1413,1272,0,1324,1117,0,1457,0,1328,1337,908,0,1178,0,1435,1346,0,0,1433,1458,0,1039,1289,1326,0,1449,1096,0,1294,1255,0,0,1371,0,1223,0,1179,0,0,1219,0,1219,1337,1366,1092,0,0,1169,1421,1360,0,1241,0,1337,1413,1406,1034,1353,0,0,0,1161,0,1330,1421,1361,1406,0,1598,899,1158,1369,1430,0,0,1150,1411,997,1448,0,0,0,0,1225,1318,1036,993,1168,1334,0,0,1409,0,1406,1126,1163,0,1236,1419,1023,0,1418,1019,1346,0,991,1201,1127,1540,815,1237,1374,1053,0,1069,0,0,1081,773,1046,0,1634,0,1425,0,1210,1001,1247,0,1303,0,1321,1547,1184,0,1751,1430,1234,0,1311,1437,1487,1600,1261,1229,0,1512,793,1073,1130,1251,1152,1433,0,0,1333,0,0,1121,1402,1352,1133,1469,1187,1232,1759,1779,0,0,1421,1304,0,1098,0,1231,0,1384,1423,1253,0,0,1298,1497,1423,1399,1156,1305,1585,1325,1062,1272,1303,1145,1233,1103,0,911,0,0,1407,0,1550,1047,1037,1068,0,971,1170,1487,740,1676,0,0,1069,1183,1404,1171,1356,484,1042,1480,1258,996,1187,1218,1233,0,0,1453,0,1772,887,1365,1032,1076,0,1045,1357,1227,1301];
var places = [];
var deltas = [];
var numbers = [];

function modifyPartyHtml(index, elem)
{
    var delta = 0;
    if (partyNum > 0)
    {
        var handle = $(elem).find("td:eq(1)").find("a").first().html();
        if (handle in deltas)
            delta = Math.round(deltas[handle]);
    }
    var text;
    if (partyNum == 0)
    {
        text = "<th class='top right' style='width: 4em;'><span title='Rating change''>&Delta;</span></th>";
    }
    else
    {
        var darkClass = "";
        if (partyNum % 2 == 1)
            darkClass = "dark ";
        if (delta > 0)
            text = "<td class='" + darkClass + "right'><span style='color:green;font-weight:bold;'>+" + delta + "</span></td>";
        else
            text = "<td class='" + darkClass + "right'><span style='color:gray;font-weight:bold;'>" + (delta > 0 ? "-" : "") + delta + "</span></td>";        
    }
    ++partyNum;
    $(elem).append(text);
}

function showDeltas()
{
    var count = $(".standings").find("tr").length;
    if (count > 2)
    {
        var contestId = document.location.href.replace(/\D+/ig, ',').substr(1).split(',')[0];
        $.getJSON("http://codeforces.com/api/contest.standings?contestId=" + contestId,
            function(data)
            {
                var handles = [];
                for (var i = 0; i < data.result.rows.length; ++i)
                {
                    places[i] = data.result.rows[i].rank;
                    handles.push(data.result.rows[i].party.members[0].handle);
                }
                chrome.extension.sendRequest({"handles" : handles}, function(storedRatings) {
                    // if (storedRatings.length == handles.length)
                    {
                        // for (var i = 0; i < storedRatings.length; ++i)
                        //     ratings[i] = storedRatings[i];
                        for (var i = 0; i < ratings.length; ++i)
                            if (ratings[i] == 0)
                                ratings[i] = 1500;
                        deltas = CalculateRatingChanges(ratings, places, handles);
                    }
                    $(".standings").find("tr").first().find("th").last().removeClass("right");
                    $(".standings").find("tr").find("td").removeClass("right");
                    $(".standings").find("tr").each(modifyPartyHtml);
                    if (count % 2 == 0)
                        $(".standings").find("tr").last().find("td").last().replaceWith("<td class='smaller bottom dark right'> </td>");
                    else
                        $(".standings").find("tr").last().find("td").last().replaceWith("<td class='smaller bottom right'> </td>");
                });
            }
        );
    }
}

showDeltas();
